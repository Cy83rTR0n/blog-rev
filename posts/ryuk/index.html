<!doctype html><html lang=en-us><head><title>Ryuk // Cy83rTR0n's Blog</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.111.3"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Cy83rTR0n"><meta name=description content><link rel=stylesheet href=/blog-rev/css/main.min.3c3c186cd62e563ad6e2f00a89dbee656ab912d1d46f856b5605dd0232521e2a.css><meta name=twitter:card content="summary"><meta name=twitter:title content="Ryuk"><meta name=twitter:description content="Ryuk Malware Below details are for stage 1
Name Ryuk Malware 1. MD5 5ac0f050f93f86e69026faea1fbb4450 2. SHA-1 9709774fde9ec740ad6fed8ed79903296ca9d571 3. SHA-256 23f8aa94ffb3c08a62735fe7fee5799880a8f322ce1d55ec49a13a3f85312db2 4. File type Win32 EX Overview It is a 2 stage malware, where the first stage when initiated suddenly vanishes from the system and drops the second stage to carry out the task of privilege escalation, persistence, and process injection. The details about how it carries out each stage are mentioned further in the report."><meta property="og:title" content="Ryuk"><meta property="og:description" content="Ryuk Malware Below details are for stage 1
Name Ryuk Malware 1. MD5 5ac0f050f93f86e69026faea1fbb4450 2. SHA-1 9709774fde9ec740ad6fed8ed79903296ca9d571 3. SHA-256 23f8aa94ffb3c08a62735fe7fee5799880a8f322ce1d55ec49a13a3f85312db2 4. File type Win32 EX Overview It is a 2 stage malware, where the first stage when initiated suddenly vanishes from the system and drops the second stage to carry out the task of privilege escalation, persistence, and process injection. The details about how it carries out each stage are mentioned further in the report."><meta property="og:type" content="article"><meta property="og:url" content="https://Cy83rTR0n.github.io/blog-rev/posts/ryuk/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-12T17:13:36+00:00"><meta property="article:modified_time" content="2023-03-12T17:13:36+00:00"></head><body><header class=app-header><a href=https://Cy83rTR0n.github.io/blog-rev/><img class=app-header-avatar src=/blog-rev/avatar.jpg alt=Cy83rTR0n></a>
<span class=app-header-title>Cy83rTR0n's Blog</span><p>A blog about all things technical.</p><div class=app-header-social><a href=https://github.com/Cy83rTR0n target=_blank rel="noreferrer noopener me"><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>GitHub</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://twitter.com/_Cy83rTR0n target=_blank rel="noreferrer noopener me"><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter"><title>Twitter</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Ryuk</h1><div class=post-meta><div><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Mar 12, 2023</div><div><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>3 min read</div></div></header><div class=post-content><h1 id=ryuk-malware>Ryuk Malware</h1><p>Below details are for stage 1</p><table><thead><tr><th>Name</th><th>Ryuk Malware</th></tr></thead><tbody><tr><td>1. MD5</td><td>5ac0f050f93f86e69026faea1fbb4450</td></tr><tr><td>2. SHA-1</td><td>9709774fde9ec740ad6fed8ed79903296ca9d571</td></tr><tr><td>3. SHA-256</td><td>23f8aa94ffb3c08a62735fe7fee5799880a8f322ce1d55ec49a13a3f85312db2</td></tr><tr><td>4. File type</td><td>Win32 EX</td></tr></tbody></table><h2 id=overview>Overview</h2><p>It is a 2 stage malware, where the first stage when initiated suddenly vanishes from the system and drops the second stage to carry out the task of privilege escalation, persistence, and process injection. The details about how it carries out each stage are mentioned further in the report.</p><h2 id=preliminary-analysis>Preliminary Analysis</h2><h3 id=snapshot-from-virustotal>Snapshot from VirusTotal</h3><p><img src=Ryuk%20Malware%201c5ef46338974ae08252bd9df54da398/Untitled.png alt=Untitled></p><h3 id=snapshot-from-hybridanalysis>Snapshot from HybridAnalysis</h3><p><img src=Ryuk%20Malware%201c5ef46338974ae08252bd9df54da398/Untitled%201.png alt=Untitled></p><h3 id=mitre-attck-analysis>MITRE ATT&amp;CK Analysis</h3><ul><li>Persistence</li><li>Privilege Escalation</li><li>Defense Evasion</li><li>Credential Access</li><li>Discovery</li><li>Exfiltration</li></ul><p><strong>For better Visuals and info refer to the given links</strong></p><p><a href=https://www.hybrid-analysis.com/sample/23f8aa94ffb3c08a62735fe7fee5799880a8f322ce1d55ec49a13a3f85312db2/5b78ac487ca3e1394667d414>https://www.hybrid-analysis.com/sample/23f8aa94ffb3c08a62735fe7fee5799880a8f322ce1d55ec49a13a3f85312db2/5b78ac487ca3e1394667d414</a></p><p><a href=https://www.virustotal.com/gui/file/23f8aa94ffb3c08a62735fe7fee5799880a8f322ce1d55ec49a13a3f85312db2/>https://www.virustotal.com/gui/file/23f8aa94ffb3c08a62735fe7fee5799880a8f322ce1d55ec49a13a3f85312db2/</a></p><h2 id=basic-analysis-of-stage-i>Basic Analysis of Stage I</h2><p>At the very start, we see that the ransomware tries to retrieve the Major version of the system and based on it drops the second stage either in of the specified paths.</p><p><img src=Ryuk%20Malware%201c5ef46338974ae08252bd9df54da398/Untitled%202.png alt=Untitled></p><h2 id=dynamic-analysis-of-stage-i>Dynamic Analysis of Stage I</h2><p>Later we see that an executable is made on the fly whose name is random 5 characters. later is appended with .exe extension.</p><p><img src=Ryuk%20Malware%201c5ef46338974ae08252bd9df54da398/Untitled%203.png alt=Untitled></p><p>Later when it tries to create the file in the directory incase it fails the name of the file is kept as ryuV.exe, Hence a ‘V’ being replaced in place of ‘k’.</p><p><img src=Ryuk%20Malware%201c5ef46338974ae08252bd9df54da398/Untitled%204.png alt=Untitled></p><p>After creation of the file, its time to load the malicious code inside of it. For this stage 1 checks whether the current process is running in 64 bit or 32 bit operating system using IsWowProcess(). Based on the result stage 1 loads code into the newly created file.</p><p>For getting the relevant imports of dlls Ryuk uses LoadlibraryA(”Kernel32.dll”) and GetProcAddress().</p><p><img src=Ryuk%20Malware%201c5ef46338974ae08252bd9df54da398/Untitled%205.png alt=Untitled></p><p>Finally once the file is ready Ryuk uses ShellExecuteW() to commit the file to the specified directory.</p><h2 id=stage-ii>Stage II</h2><table><thead><tr><th>SHA256</th><th>8b0a5fb13309623c3518473551cb1f55d38d8450129d4a3c16b476f7b2867d7d</th></tr></thead></table><h3 id=analysis>Analysis</h3><p>Well, this part is still a little mystery to me, however referring to the old analysis I came to this point once stage I has completed its job of making the second one it passes to it as a command line argument and deletes itself.</p><p><img src=Ryuk%20Malware%201c5ef46338974ae08252bd9df54da398/Untitled%206.png alt=Untitled></p><p>To gain Persistence the ransomware uses the trick to add a run key to the registry.</p><p><img src=Ryuk%20Malware%201c5ef46338974ae08252bd9df54da398/Untitled%207.png alt=Untitled></p><p>the full command goes like</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>C:\Windows\System32\cmd.exe /C REG ADD <span style=color:#e6db74>&#34;HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run&#34;</span> /v <span style=color:#e6db74>&#34;svchos&#34;</span> /t REG_SZ /d <span style=color:#e6db74>&#34;C:\users\Public\BPWPc.exe&#34;</span> /f
</span></span></code></pre></div><p>Further we check that whether the current user has a “SeDebugPrivilege” using its LUID. Incase it is not there it adjust the privilege using AdjustTokenPrivileges(). Hence Privilege of the current process is escalated because we need special permissions to perform the next attack.</p><p><img src=Ryuk%20Malware%201c5ef46338974ae08252bd9df54da398/Untitled%208.png alt=Untitled></p><p>Next the ryuk looks whether the Domain name is NTA or not. Based on that it set the values of the array in which different process’s details are collected.</p><p><img src=Ryuk%20Malware%201c5ef46338974ae08252bd9df54da398/Untitled%209.png alt=Untitled></p><p>In the following screenshots we see that ryuk uses process injection technique. It does this by virtually allocating room for the code and then writing to it.</p><p><img src=Ryuk%20Malware%201c5ef46338974ae08252bd9df54da398/Untitled%2010.png alt=Untitled></p><p><img src=Ryuk%20Malware%201c5ef46338974ae08252bd9df54da398/Untitled%2011.png alt=Untitled></p><h3 id=encryption-process>Encryption Process</h3><p>For encryption purposes the malware uses</p><ul><li>CryptEncrypt</li><li>CryptGenKey</li><li>CryptDecrypt</li><li>CryptAquireContextW</li><li>CryptDestroyKey</li><li>CryptDeriveKey</li><li>CryptImportKey</li></ul><p>They are all a part of ADVapi32.dll</p><p>Each encryption thread starts by generating a random 256 AES encryption.</p><p><img src=Ryuk%20Malware%201c5ef46338974ae08252bd9df54da398/Untitled%2012.png alt=Untitled></p><p><img src=Ryuk%20Malware%201c5ef46338974ae08252bd9df54da398/Untitled%2013.png alt=Untitled></p><p>After every file is encrypted we see that “HERMES” is being padded to each and every file</p><p><img src=Ryuk%20Malware%201c5ef46338974ae08252bd9df54da398/Untitled%2014.png alt=Untitled></p><p>it checks if a file is going to get encrypted twice.</p><p><img src=Ryuk%20Malware%201c5ef46338974ae08252bd9df54da398/Untitled%2015.png alt=Untitled></p><p>The important apis used in malware are as follows :</p><ul><li>CryptEncrypt</li><li>CryptGenKey</li><li>CryptDecrypt</li><li>CryptAquireContextW</li><li>CryptDestroyKey</li><li>CryptDeriveKey</li><li>CryptImportKey</li><li>VirtualFree</li><li>WriteProcessMemory</li><li>VirtualAllocEx</li><li>LookupPrivilegeValue</li><li>GetProcAddress</li><li>AdjustTokenPrivilege</li><li>ShellExecuteW</li><li>FreeLibrary</li><li>CreateRemoteThread</li></ul></div><div class=post-footer></div></article></main></body></html>